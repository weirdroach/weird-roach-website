<script>
    // Fetch products from API
    async function loadProducts() {
        const productsGrid = document.getElementById('products-grid');
        try {
            showLoadingState();
            const response = await fetch('/api/products');

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const products = await response.json();
            hideLoadingState();
            displayProducts(products);
        } catch (error) {
            console.error('Error loading products:', error);
            hideLoadingState();
            productsGrid.innerHTML = `<div class="error-message"><p>Error loading products. ${error.message}</p></div>`;
        }
    }

    function displayProducts(products) {
        const grid = document.getElementById('products-grid');
        grid.innerHTML = '';

        products.forEach(product => {
            const productElement = document.createElement('article');
            productElement.className = 'product-item';

            const variants = product.variants || [];
            const firstVariant = variants[0] || {};
            let imageUrl = firstVariant.preview_url || product.thumbnail_url;
            let price = firstVariant.price || '0.00';

            productElement.innerHTML = `
                <div class="product-image-container">
                    <img src="${imageUrl}" alt="${product.name}" class="product-image" onclick="openModal('${imageUrl}', '${product.name}')">
                </div>
                <div class="product-details">
                    <h2 class="product-name">${product.name}</h2>
                    <p class="product-price">$${price}</p>
                    
                    <div class="size-select">
                        <select id="size-${product.id}">
                            <option value="">Select Size</option>
                            ${variants.map(v => `<option value="${v.id}" data-price="${v.price}">${v.size}</option>`).join('')}
                        </select>
                    </div>

                    <button class="add-to-cart-button" onclick="addToCart('${product.name}', '${product.id}')">
                        Add to Cart
                    </button>
                </div>
            `;

            grid.appendChild(productElement);

            // Handle size selection updates price dynamically
            const sizeSelect = productElement.querySelector(`#size-${product.id}`);
            sizeSelect.addEventListener('change', () => {
                const selectedOption = sizeSelect.options[sizeSelect.selectedIndex];
                if (selectedOption.value) {
                    productElement.querySelector('.product-price').textContent = `$${selectedOption.getAttribute('data-price')}`;
                }
            });
        });
    }

    // ðŸ›’ Cart System (with variant_id)
    let cart = [];
    
    function addToCart(productName, productId) {
        const sizeSelect = document.querySelector(`#size-${productId}`);
        const selectedOption = sizeSelect.options[sizeSelect.selectedIndex];

        if (!selectedOption.value) {
            alert("Please select a size before adding to cart.");
            return;
        }

        const variantId = selectedOption.value;
        const price = selectedOption.getAttribute('data-price');
        const image = document.querySelector(`#size-${productId}`).closest('.product-item').querySelector('.product-image').src;

        cart.push({ name: productName, variant_id: variantId, price, quantity: 1, image });
        updateCartUI();
    }

    function updateCartUI() {
        const cartItemsContainer = document.querySelector('.cart-items');
        const cartCount = document.querySelector('.cart-count');
        const cartTotal = document.querySelector('.cart-total span:last-child');
        const checkoutButton = document.querySelector('.checkout-button');

        cartCount.textContent = cart.length;
        cartItemsContainer.innerHTML = '';
        let total = 0;

        cart.forEach((item, index) => {
            total += parseFloat(item.price) * item.quantity;
            cartItemsContainer.innerHTML += `
                <div class="cart-item">
                    <img src="${item.image}" alt="${item.name}" class="cart-item-image">
                    <div class="cart-item-details">
                        <h3>${item.name}</h3>
                        <p>$${item.price}</p>
                        <div class="quantity-controls">
                            <button onclick="updateQuantity(${index}, -1)">-</button>
                            <span>${item.quantity}</span>
                            <button onclick="updateQuantity(${index}, 1)">+</button>
                        </div>
                    </div>
                    <button class="remove-item" onclick="removeFromCart(${index})">Ã—</button>
                </div>
            `;
        });

        cartTotal.textContent = `$${total.toFixed(2)}`;
        checkoutButton.disabled = cart.length === 0;
    }

    async function checkout() {
        try {
            const response = await fetch('/api/create-checkout-session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ items: cart })
            });

            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Checkout failed');

            window.location.href = data.url; // Redirect to Stripe Checkout
        } catch (error) {
            console.error('Checkout Error:', error);
            alert("Failed to start checkout. Try again.");
        }
    }

    document.querySelector('.checkout-button').addEventListener('click', checkout);

    window.addEventListener('load', loadProducts);
</script>

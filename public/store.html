<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Store - Weird Roach</title>
    <link rel="stylesheet" href="css/store.css">
</head>
<body>

    <main>
        <h1>Weird Roach Store</h1>

        <div class="store-container">
            <div id="products-grid" class="products-grid">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading products...</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        async function loadProducts() {
            const productsGrid = document.getElementById('products-grid');
            try {
                productsGrid.innerHTML = `<p>Loading products...</p>`;

                const response = await fetch('/api/products');
                if (!response.ok) throw new Error(`HTTP error: ${response.status}`);

                const products = await response.json();
                if (!products || products.length === 0) {
                    productsGrid.innerHTML = `<p>No products available.</p>`;
                    return;
                }

                productsGrid.innerHTML = '';
                displayProducts(products);
            } catch (error) {
                console.error('Error loading products:', error);
                productsGrid.innerHTML = `<p>Error loading products. Try again later.</p>`;
            }
        }

        function extractColorAndSize(name) {
            const parts = name.split(" / "); // Example: "French Elephant Pullover / Black / M"
            return {
                color: parts.length >= 2 ? parts[1] : "Unknown",
                size: parts.length >= 3 ? parts[2] : "Unknown"
            };
        }

        function displayProducts(products) {
            const grid = document.getElementById('products-grid');
            grid.innerHTML = '';

            products.forEach(product => {
                const productElement = document.createElement('article');
                productElement.className = 'product-item';

                const variants = product.variants || [];
                const colors = [...new Set(variants.map(v => extractColorAndSize(v.name).color))];
                const sizes = [...new Set(variants.map(v => extractColorAndSize(v.name).size))];

                const firstVariant = variants[0] || {};
                const price = firstVariant.price || '0.00';
                let imageUrl = firstVariant.image || product.thumbnail_url;

                productElement.innerHTML = `
                    <div class="product-image-container">
                        <img src="${imageUrl}" class="product-image" onclick="openModal(this.src)">
                    </div>
                    <div class="product-details">
                        <h2>${product.name}</h2>
                        <p class="product-price">$${price}</p>
                        
                        ${variants.length > 0 ? `
                            <div class="variant-options">
                                <div class="color-options">
                                    ${colors.map(color => `
                                        <button class="color-option" 
                                                data-color="${color}"
                                                style="background-color: ${getColorValue(color)}">
                                        </button>
                                    `).join('')}
                                </div>
                                <div class="size-select">
                                    <select id="size-${product.id}">
                                        <option value="">Select Size</option>
                                        ${sizes.map(size => `<option value="${size}">${size}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                        ` : '<p>No variants available</p>'}

                        <button class="add-to-cart-button" disabled>Add to Cart</button>
                    </div>
                `;

                const colorOptions = productElement.querySelectorAll('.color-option');
                const sizeSelect = productElement.querySelector(`#size-${product.id}`);
                const addToCartButton = productElement.querySelector('.add-to-cart-button');

                let selectedColor = null;
                let selectedSize = null;

                function updateProductDisplay() {
                    if (!selectedColor || !selectedSize) return;

                    const selectedVariant = variants.find(v => {
                        const { color, size } = extractColorAndSize(v.name);
                        return color === selectedColor && size === selectedSize;
                    });

                    if (selectedVariant) {
                        productElement.querySelector('.product-image').src = selectedVariant.image;
                        productElement.querySelector('.product-price').textContent = `$${selectedVariant.price}`;
                        addToCartButton.removeAttribute('disabled');
                        addToCartButton.dataset.variantId = selectedVariant.variant_id;
                    } else {
                        addToCartButton.setAttribute('disabled', 'true');
                    }
                }

                colorOptions.forEach(colorBtn => {
                    colorBtn.addEventListener('click', () => {
                        colorOptions.forEach(btn => btn.classList.remove('active'));
                        colorBtn.classList.add('active');
                        selectedColor = colorBtn.dataset.color;
                        updateProductDisplay();
                    });
                });

                sizeSelect.addEventListener('change', (event) => {
                    selectedSize = event.target.value;
                    updateProductDisplay();
                });

                addToCartButton.addEventListener('click', () => {
                    if (!selectedColor || !selectedSize) {
                        alert('Please select a color and size.');
                        return;
                    }

                    const variantId = addToCartButton.dataset.variantId;
                    if (!variantId) {
                        alert('Invalid product selection.');
                        return;
                    }

                    addToCart({
                        name: product.name,
                        variant_id: variantId,
                        color: selectedColor,
                        size: selectedSize,
                        price: productElement.querySelector('.product-price').textContent.replace('$', ''),
                        quantity: 1,
                        image: productElement.querySelector('.product-image').src
                    });
                });

                grid.appendChild(productElement);
            });
        }

        function getColorValue(colorName) {
            const colorMap = {
                'black': '#000000',
                'white': '#FFFFFF',
                'red': '#FF0000',
                'blue': '#0000FF',
                'green': '#008000',
                'yellow': '#FFFF00',
                'grey': '#808080',
                'charcoal': '#36454F',
                'burgundy': '#800020',
                'navy': '#000080',
                'olive': '#808000',
                'orange': '#FFA500',
                'pink': '#FFC0CB',
                'purple': '#800080',
                'teal': '#008080'
            };
            return colorMap[colorName.toLowerCase()] || '#D3D3D3';
        }

        function openModal(src) {
            alert(`Image preview: ${src}`);
        }

        function addToCart(product) {
            console.log("Added to cart:", product);
        }

        window.addEventListener('load', loadProducts);
    </script>
</body>
</html>
